# 6.5840 Labs

## Lab 1: MapReduce

<https://pdos.csail.mit.edu/6.824/labs/lab-mr.html>

```bash
❯ cd src/main/
❯ bash test-mr.sh
*** Starting wc test.
--- wc test: PASS
*** Starting indexer test.
--- indexer test: PASS
*** Starting map parallelism test.
--- map parallelism test: PASS
*** Starting reduce parallelism test.
--- reduce parallelism test: PASS
*** Starting job count test.
--- job count test: PASS
*** Starting early exit test.
--- early exit test: PASS
*** Starting crash test.
--- crash test: PASS
*** PASSED ALL TESTS
```

## Lab 2: Key/Value Server

<https://pdos.csail.mit.edu/6.824/labs/lab-kvsrv1.html>

```bash
❯ cd src/kvsrv1
❯ go test
One client and reliable Put (reliable network)...
  ... Passed --  time  0.0s #peers 1 #RPCs     5 #Ops    0
Test: many clients racing to put values to the same key (reliable network)...
  ... Passed --  time  3.1s #peers 1 #RPCs 65325 #Ops 65325
Test: memory use many put clients (reliable network)...
  ... Passed --  time  9.4s #peers 1 #RPCs 100000 #Ops    0
One client (unreliable network)...
  ... Passed --  time  6.6s #peers 1 #RPCs   282 #Ops  218
PASS
ok      6.5840/kvsrv1   27.036s

❯ cd lock/
❯ go test
Test: 1 lock clients (reliable network)...
  ... Passed --  time  2.0s #peers 1 #RPCs   407 #Ops    0
Test: 10 lock clients (reliable network)...
  ... Passed --  time  2.2s #peers 1 #RPCs 123745 #Ops    0
Test: 1 lock clients (unreliable network)...
  ... Passed --  time  2.2s #peers 1 #RPCs    86 #Ops    0
Test: 10 lock clients (unreliable network)...
  ... Passed --  time  3.5s #peers 1 #RPCs  1768 #Ops    0
PASS
ok      6.5840/kvsrv1/lock      9.859s
```

## Lab 3: Raft

<https://pdos.csail.mit.edu/6.824/labs/lab-raft1.html>

The main branch implements a replicator goroutine per peer.
The lab3-naive branch spawns goroutine per RPC

<https://thesquareplanet.com/blog/students-guide-to-raft/>

```bash
❯ cd src/raft1
❯ go test
Test (3A): initial election (reliable network)...
  ... Passed --  time  3.0s #peers 3 #RPCs    56 #Ops    0
Test (3A): election after network failure (reliable network)...
  ... Passed --  time  6.0s #peers 3 #RPCs   164 #Ops    0
Test (3A): multiple elections (reliable network)...
  ... Passed --  time  5.6s #peers 7 #RPCs   564 #Ops    0
Test (3B): basic agreement (reliable network)...
  ... Passed --  time  0.6s #peers 3 #RPCs    16 #Ops    0
Test (3B): RPC byte count (reliable network)...
  ... Passed --  time  1.5s #peers 3 #RPCs    50 #Ops    0
Test (3B): test progressive failure of followers (reliable network)...
  ... Passed --  time  4.7s #peers 3 #RPCs   117 #Ops    0
Test (3B): test failure of leaders (reliable network)...
  ... Passed --  time  5.3s #peers 3 #RPCs   198 #Ops    0
Test (3B): agreement after follower reconnects (reliable network)...
  ... Passed --  time  3.5s #peers 3 #RPCs    83 #Ops    0
Test (3B): no agreement if too many followers disconnect (reliable network)...
  ... Passed --  time  3.6s #peers 5 #RPCs   198 #Ops    0
Test (3B): concurrent Start()s (reliable network)...
  ... Passed --  time  0.6s #peers 3 #RPCs    14 #Ops    0
Test (3B): rejoin of partitioned leader (reliable network)...
  ... Passed --  time  4.1s #peers 3 #RPCs   143 #Ops    0
Test (3B): leader backs up quickly over incorrect follower logs (reliable network)...
  ... Passed --  time 17.0s #peers 5 #RPCs  1562 #Ops    0
Test (3B): RPC counts arent too high (reliable network)...
  ... Passed --  time  2.6s #peers 3 #RPCs    44 #Ops    0
Test (3C): basic persistence (reliable network)...
  ... Passed --  time  4.0s #peers 3 #RPCs    75 #Ops    0
Test (3C): more persistence (reliable network)...
  ... Passed --  time 12.3s #peers 5 #RPCs   344 #Ops    0
Test (3C): partitioned leader and one follower crash, leader restarts (reliable network)...
  ... Passed --  time  1.7s #peers 3 #RPCs    38 #Ops    0
Test (3C): Figure 8 (reliable network)...
  ... Passed --  time 30.2s #peers 5 #RPCs   970 #Ops    0
Test (3C): unreliable agreement (unreliable network)...
  ... Passed --  time  2.4s #peers 5 #RPCs   360 #Ops    0
Test (3C): Figure 8 (unreliable) (unreliable network)...
  ... Passed --  time 31.8s #peers 5 #RPCs  3137 #Ops    0
Test (3C): churn (reliable network)...
  ... Passed --  time 16.3s #peers 5 #RPCs  2163 #Ops    0
Test (3C): unreliable churn (unreliable network)...
  ... Passed --  time 16.2s #peers 5 #RPCs  1130 #Ops    0
Test (3D): snapshots basic (reliable network)...
  ... Passed --  time  4.1s #peers 3 #RPCs   152 #Ops    0
Test (3D): install snapshots (disconnect) (reliable network)...
  ... Passed --  time 45.7s #peers 3 #RPCs  1152 #Ops    0
Test (3D): install snapshots (disconnect) (unreliable network)...
  ... Passed --  time 45.2s #peers 3 #RPCs  1174 #Ops    0
Test (3D): install snapshots (crash) (reliable network)...
  ... Passed --  time 33.3s #peers 3 #RPCs   698 #Ops    0
Test (3D): install snapshots (crash) (unreliable network)...
  ... Passed --  time 38.0s #peers 3 #RPCs   802 #Ops    0
Test (3D): crash and restart all servers (unreliable network)...
  ... Passed --  time 10.1s #peers 3 #RPCs   311 #Ops    0
Test (3D): snapshot initialization after crash (unreliable network)...
  ... Passed --  time  3.7s #peers 3 #RPCs    90 #Ops    0
PASS
ok      6.5840/raft1    352.991s
```

Run multiple times with the bash script

```bash
for i in {1..20}; do go test || break; done
```

## Lab 4: Fault-tolerant Key/Value Service

<https://pdos.csail.mit.edu/6.824/labs/lab-kvraft1.html>

```bash
❯ cd src/kvraft1/rsm/
❯ go test
Test RSM basic (reliable network)...
  ... Passed --  time  1.4s #peers 3 #RPCs    44 #Ops    0
Test concurrent submit (reliable network)...
  ... Passed --  time  0.6s #peers 3 #RPCs    12 #Ops    0
Test Leader Failure (reliable network)...
  ... Passed --  time  1.7s #peers 3 #RPCs    49 #Ops    0
Test Leader Partition (reliable network)...
  ... Passed --  time  2.1s #peers 3 #RPCs   131 #Ops    0
Test Restart (reliable network)...
  ... Passed --  time 12.9s #peers 3 #RPCs   430 #Ops    0
Test Shutdown (reliable network)...
  ... Passed --  time 10.0s #peers 3 #RPCs     0 #Ops    0
Test Restart and submit (reliable network)...
  ... Passed --  time 14.9s #peers 3 #RPCs   462 #Ops    0
Test creating and restoring snapshot (reliable network)...
labgob warning: Decoding into a non-default variable/field int may not work
  ... Passed --  time  1.9s #peers 3 #RPCs   202 #Ops    0
PASS
ok      6.5840/kvraft1/rsm      45.878s

❯ cd ..
❯ go test
Test: one client (4B basic) (reliable network)...
  ... Passed --  time  3.0s #peers 5 #RPCs  3012 #Ops  461
Test: one client (4B speed) (reliable network)...
  ... Passed --  time  5.9s #peers 3 #RPCs  4149 #Ops    0
Test: many clients (4B many clients) (reliable network)...
  ... Passed --  time  3.2s #peers 5 #RPCs  4464 #Ops 1677
Test: many clients (4B many clients) (unreliable network)...
  ... Passed --  time  4.5s #peers 5 #RPCs  1269 #Ops  151
Test: one client (4B progress in majority) (unreliable network)...
  ... Passed --  time  2.5s #peers 5 #RPCs   281 #Ops    3
Test: no progress in minority (4B) (unreliable network)...
  ... Passed --  time  1.8s #peers 5 #RPCs   327 #Ops    3
Test: completion after heal (4B) (unreliable network)...
  ... Passed --  time  1.2s #peers 5 #RPCs    97 #Ops    4
Test: partitions, one client (4B partitions, one client) (reliable network)...
  ... Passed --  time  9.3s #peers 5 #RPCs  2875 #Ops  459
Test: partitions, many clients (4B partitions, many clients (4B)) (reliable network)...
  ... Passed --  time 11.4s #peers 5 #RPCs  6916 #Ops 1733
Test: restarts, one client (4B restarts, one client 4B ) (reliable network)...
  ... Passed --  time  6.0s #peers 5 #RPCs  1021 #Ops  131
Test: restarts, many clients (4B restarts, many clients) (reliable network)...
  ... Passed --  time  6.3s #peers 5 #RPCs  3108 #Ops 1147
Test: restarts, many clients (4B restarts, many clients ) (unreliable network)...
  ... Passed --  time  7.5s #peers 5 #RPCs  1089 #Ops   95
Test: restarts, partitions, many clients (4B restarts, partitions, many clients) (reliable network)...
  ... Passed --  time 12.1s #peers 5 #RPCs  3440 #Ops  941
Test: restarts, partitions, many clients (4B restarts, partitions, many clients) (unreliable network)...
  ... Passed --  time 13.5s #peers 5 #RPCs  1445 #Ops   89
Test: restarts, partitions, random keys, many clients (4B restarts, partitions, random keys, many clients) (unreliable network)...        
  ... Passed --  time 19.9s #peers 7 #RPCs  5649 #Ops  128
Test: snapshots, one client (4C SnapshotsRPC) (reliable network)...
Test: InstallSnapshot RPC (4C) (reliable network)...
  ... Passed --  time  2.3s #peers 3 #RPCs   220 #Ops   63
Test: snapshots, one client (4C snapshot size is reasonable) (reliable network)...
  ... Passed --  time  6.5s #peers 3 #RPCs  2111 #Ops  800
Test: snapshots, one client (4C speed) (reliable network)...
  ... Passed --  time  6.1s #peers 3 #RPCs  3243 #Ops    0
Test: restarts, snapshots, one client (4C restarts, snapshots, one client) (reliable network)...
  ... Passed --  time  6.0s #peers 5 #RPCs  1564 #Ops  227
Test: restarts, snapshots, many clients (4C restarts, snapshots, many clients ) (reliable network)...
info: linearizability check timed out, assuming history is ok
info: linearizability check timed out, assuming history is ok
info: linearizability check timed out, assuming history is ok
  ... Passed --  time  9.7s #peers 5 #RPCs 11288 #Ops 4427
Test: snapshots, many clients (4C unreliable net, snapshots, many clients) (unreliable network)...
  ... Passed --  time  4.1s #peers 5 #RPCs  1438 #Ops  119
Test: restarts, snapshots, many clients (4C unreliable net, restarts, snapshots, many clients) (unreliable network)...
  ... Passed --  time  7.5s #peers 5 #RPCs  1008 #Ops   71
Test: restarts, partitions, snapshots, many clients (4C unreliable net, restarts, partitions, snapshots, many clients) (unreliable network)...
  ... Passed --  time 12.2s #peers 5 #RPCs  1325 #Ops   69
Test: restarts, partitions, snapshots, random keys, many clients (4C unreliable net, restarts, partitions, snapshots, random keys, many clients) (unreliable network)...
  ... Passed --  time 16.9s #peers 7 #RPCs  4642 #Ops  154
PASS
ok      6.5840/kvraft1  179.884s
```

Linearizability check (Porcupine) occassionally times out for TestSnapshotRecoverManyClients4C using 20 clients. If we test it for 15 clients then it doesn't timeout.

## Lab 5: Sharded Key/Value Service

<https://pdos.csail.mit.edu/6.824/labs/lab-shard1.html>

Individual tests (5A, 5B, 5C) pass but combined tests `go test` fail

```bash
❯ cd src/shardkv1/
❯ go test -run 5A
Test (5A): Init and Query ... (reliable network)...
  ... Passed --  time  0.0s #peers 1 #RPCs     2 #Ops    0
Test (5A): one shard group ... (reliable network)...
  ... Passed --  time  5.0s #peers 1 #RPCs  1227 #Ops  180
Test (5A): a group joins... (reliable network)...
  ... Passed --  time  7.9s #peers 1 #RPCs  4090 #Ops  180
Test (5A): delete ... (reliable network)...
  ... Passed --  time  3.6s #peers 1 #RPCs  1942 #Ops  360
Test (5A): basic groups join/leave ... (reliable network)...
  ... Passed --  time  7.8s #peers 1 #RPCs  4041 #Ops  240
Test (5A): many groups join/leave ... (reliable network)...
  ... Passed --  time 20.7s #peers 1 #RPCs  3850 #Ops  180
Test (5A): many groups join/leave ... (unreliable network)...
  ... Passed --  time 81.7s #peers 1 #RPCs  8882 #Ops  180
Test (5A): shutdown ... (reliable network)...
  ... Passed --  time 17.8s #peers 1 #RPCs  2559 #Ops  180
Test (5A): progress ... (reliable network)...
  ... Passed --  time 11.1s #peers 1 #RPCs  1079 #Ops   82
Test (5A): progress ... (reliable network)...
  ... Passed --  time 16.9s #peers 1 #RPCs  2394 #Ops  170
Test (5A): one concurrent clerk reliable... (reliable network)...
  ... Passed --  time 20.3s #peers 1 #RPCs  2976 #Ops  214
Test (5A): many concurrent clerks reliable... (reliable network)...
  ... Passed --  time 22.4s #peers 1 #RPCs  4820 #Ops  682
Test (5A): one concurrent clerk unreliable ... (unreliable network)...
  ... Passed --  time 44.1s #peers 1 #RPCs  4663 #Ops   52
Test (5A): many concurrent clerks unreliable... (unreliable network)...
  ... Passed --  time 53.1s #peers 1 #RPCs  6860 #Ops  378
PASS
ok      6.5840/shardkv1 313.100s

❯ go test -run 5B
Test (5B): Join/leave while a shardgrp is down... (reliable network)...
  ... Passed --  time  5.1s #peers 1 #RPCs  1175 #Ops  120
Test (5B): recover controller ... (reliable network)...
  ... Passed --  time 18.4s #peers 1 #RPCs  4594 #Ops  360
PASS
ok      6.5840/shardkv1 24.012s

❯ go test -run 5C
Test (5C): Concurrent ctrlers ... (reliable network)...
  ... Passed --  time  5.2s #peers 1 #RPCs  2691 #Ops  120
Test (5C): Concurrent ctrlers ... (unreliable network)...
  ... Passed --  time 25.7s #peers 1 #RPCs  4864 #Ops  120
Test (5C): partition controller in join... (reliable network)...
  ... Passed --  time  5.2s #peers 1 #RPCs  1324 #Ops  120
Test (5C): controllers with leased leadership ... (reliable network)...
  ... Passed --  time 23.3s #peers 1 #RPCs  4837 #Ops  360
Test (5C): controllers with leased leadership ... (unreliable network)...
  ... Passed --  time 46.5s #peers 1 #RPCs  4683 #Ops  240
Test (5C): controllers with leased leadership ... (reliable network)...
  ... Passed --  time 60.5s #peers 1 #RPCs 29092 #Ops 5498
Test (5C): controllers with leased leadership ... (unreliable network)...
  ... Passed --  time 60.7s #peers 1 #RPCs 18052 #Ops 2250
PASS
ok      6.5840/shardkv1 228.003s
```

When running combined tests

```bash
❯ go test
...
Test (5A): progress ... (reliable network)...
Fatal: Two few gets finished 88; expected more than 100
        C:/Users/mabhi/OneDrive/Desktop/MIT-6.5840-distributed-systems/src/shardkv1/shardkv_test.go:413
info: wrote visualization to C:\Users\mabhi\AppData\Local\Temp\porcupine-1828895421.html
--- FAIL: TestProgressJoin5A (14.78s)
...
Test (5C): Concurrent ctrlers ... (reliable network)...
>> Hangs and times out
```

---

## Project Ideas

- High-performance Raft with cluster membership and snapshot chunks
- DFS / HDFS
- Spark implementation
- Object store S3
- Asynchronous replication - eventual consistency like DynamoDB, - Social media likes, DNS
- CDN - distributed cooperative web cache like Cloudflare
- File synchronizer like Google Drive
- Collaborative editor with CRDT / OT like Google Doc - causal consistency
- Distributed block store like Amazon EBS
- Use modern high-speed NIC features (e.g. RDMA or DPDK) to build a high-speed service, perhaps with replication or transactions.
